# 开发总结

## 一、瀑布流布局 & 图片自适应 & 列数切换

**问题：**  
图片尺寸不一，需实现瀑布流效果，并支持 1 列 / 2 列自由切换。

**解决：**

- 使用 `StaggeredGridLayoutManager` 实现纵向瀑布流。
- 在 `CardAdapter` 中根据 `imageHigh / imageWidth` 动态计算高度，并将比例限制在 0.7~1.3，避免极端长图/宽图破坏布局。
- Adapter 内维护当前列数与 item 宽度，提供 `changeLine()` 切换 1/2 列；
- `MainActivity` 中通过 `GestureDetector` 监听双击事件，双击时调用 `changeLine()` 并同步更新 `spanCount`。

---

## 二、分页加载 & 刷新状态的 MVVM + 协程实现

**问题：**  
需要统一处理首次加载、下拉刷新、滑动加载更多，同时保证结构清晰、易维护。

**解决：**

- 采用 MVVM 分层：
  - `MainActivity`：只负责 UI 展示和交互；
  - `MainViewModel`：负责分页逻辑与业务状态；
  - `MyRepository`：统一封装数据访问。
- 使用 `sealed class State` 定义 `Loading / success / Error`，通过 `LiveData<State>` 对外暴露。
- 在 `ViewModel` 中使用 `viewModelScope.launch` 调用仓库：
  - 刷新时重置页码和列表；
  - 成功则累加数据并发送 `State.success`；
  - 失败则发送 `State.Error`。
- `Activity` 侧通过滚动监听触发加载更多，通过 `SwipeRefreshLayout` 触发刷新。

---

## 三、点赞交互的高效局部刷新

**问题：**  
点赞只影响爱心状态和点赞数，如果全量刷新列表会增加开销、影响流畅度。

**解决：**

- 使用 `ListAdapter + DiffUtil.ItemCallback` 自动计算差异。
- 在 `getChangePayload` 中只关注 `loveCount` 和 `isLove` 的变化，返回对应的 `Bundle` 作为 payload。
- 在重写的 `onBindViewHolder(holder, position, payloads)` 中：
  - 若 `payloads` 为空则正常完整绑定；
  - 若 `payloads` 不为空则只调用 `holder.checkLove()` 更新爱心图标和数字。
- 点赞逻辑放在 `MainViewModel.touchLove()` 中，使用 `old.copy(...)` 生成新 `CardBean`，更新列表并触发 DiffUtil 精准对比。

---


